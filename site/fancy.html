<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Network Watch — Fancy</title>
  <!-- Anime.js (CDN). No SRI so it won’t silently fail and leave the page blank. -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#101a33;
      --panel2:#0f1730;
      --text:#e8edff;
      --muted:#9aa7d6;
      --grid:#223056;
      --accent:#7aa2ff;
      --good:#3ddc97;
      --warn:#ffcc66;
      --bad:#ff5c7a;
      --shadow: 0 20px 70px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background: radial-gradient(1200px 800px at 20% 0%, #17224a 0%, var(--bg) 55%),
                  radial-gradient(1000px 700px at 90% 20%, #1b2b5c 0%, var(--bg) 60%);
      min-height:100vh;
    }
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}

    header{
      padding:24px 22px 6px 22px;
      position:sticky;
      top:0;
      backdrop-filter: blur(10px);
      background: rgba(11,16,32,.55);
      border-bottom:1px solid rgba(255,255,255,.06);
      z-index:20;
    }
    .row{display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap:wrap;}
    h1{margin:0; font-size:20px; letter-spacing:.3px;}
    .meta{color:var(--muted); font-size:12px;}
    .nav{display:flex; gap:12px; flex-wrap:wrap; font-size:13px;}

    main{padding:18px 22px 36px 22px;}

    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:16px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr;}
    }

    .card{
      background: linear-gradient(180deg, rgba(16,26,51,.95) 0%, rgba(15,23,48,.86) 100%);
      border: 1px solid rgba(255,255,255,.07);
      border-radius: 16px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.06); display:flex; align-items:baseline; justify-content:space-between; gap:12px;}
    .card h2{margin:0; font-size:14px; letter-spacing:.2px;}
    .card .sub{color:var(--muted); font-size:12px;}
    .card .bd{padding:14px 16px;}

    .kpis{display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:10px;}
    @media (max-width: 980px){ .kpis{grid-template-columns: repeat(2, minmax(0,1fr));} }
    .kpi{padding:12px; border-radius:14px; border:1px solid rgba(255,255,255,.07); background:rgba(0,0,0,.14)}
    .kpi .label{color:var(--muted); font-size:12px;}
    .kpi .value{font-size:22px; margin-top:4px; font-weight:700;}

    .flex{display:flex; gap:14px; align-items:center; flex-wrap:wrap;}
    .ringWrap{display:flex; gap:14px; align-items:center; flex-wrap:wrap;}

    svg{display:block}

    .legend{display:grid; gap:8px; min-width:220px;}
    .legendItem{display:flex; align-items:center; justify-content:space-between; gap:10px; font-size:13px;}
    .dot{width:10px; height:10px; border-radius:999px; box-shadow:0 0 0 2px rgba(255,255,255,.08) inset}
    .legendItem .left{display:flex; align-items:center; gap:8px; color:var(--text)}
    .legendItem .right{color:var(--muted)}

    .bars{display:grid; gap:8px;}
    .bar{
      display:grid;
      grid-template-columns: 110px 1fr 62px;
      gap:10px;
      align-items:center;
    }
    .bar .name{color:var(--muted); font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
    .track{height:10px; background:rgba(255,255,255,.08); border-radius:999px; overflow:hidden; border:1px solid rgba(255,255,255,.06)}
    .fill{height:100%; width:0%; background: linear-gradient(90deg, rgba(122,162,255,1), rgba(61,220,151,1)); border-radius:999px;}
    .bar .val{font-size:12px; color:var(--text); text-align:right;}

    .table{width:100%; border-collapse:collapse; font-size:13px;}
    .table th, .table td{padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.06); vertical-align:top;}
    .table th{color:var(--muted); font-weight:600; text-align:left;}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.18); font-size:12px;}
    .pill.bad{border-color: rgba(255,92,122,.35); color:#ffd7df}
    .pill.warn{border-color: rgba(255,204,102,.35); color:#fff0cc}
    .pill.good{border-color: rgba(61,220,151,.35); color:#d6fff0}

    /* Don’t hide content by default; animations are optional. */
    .fadeIn{opacity:1; transform: translateY(0);}

    footer{padding:20px 22px; color:var(--muted); font-size:12px;}
  </style>
</head>
<body>
<header>
  <div class="row">
    <div>
      <h1>Network Watch — Fancy</h1>
      <div class="meta" id="meta">Loading latest snapshot…</div>
    </div>
    <div class="nav">
      <a href="/">Dashboard</a>
      <a href="/timeline.html">Timeline</a>
      <a href="/ip-history.html">IP history</a>
      <a href="/churn.html">Churn</a>
      <a href="/graph.html">Graph</a>
    </div>
  </div>
</header>

<main>
  <div class="kpis">
    <div class="kpi fadeIn"><div class="label">Devices (latest)</div><div class="value" id="kpiDevices">–</div></div>
    <div class="kpi fadeIn"><div class="label">Hosts w/ open ports</div><div class="value" id="kpiOpenHosts">–</div></div>
    <div class="kpi fadeIn"><div class="label">Total open port entries</div><div class="value" id="kpiOpenPorts">–</div></div>
    <div class="kpi fadeIn"><div class="label">Risk flags (sum)</div><div class="value" id="kpiRisks">–</div></div>
  </div>

  <div style="height:14px"></div>

  <div class="grid">
    <section class="card fadeIn">
      <div class="hd"><h2>Device types</h2><div class="sub">Distribution in latest snapshot</div></div>
      <div class="bd">
        <div class="ringWrap">
          <svg id="ring" width="240" height="240" viewBox="0 0 240 240" aria-label="Device type donut"></svg>
          <div class="legend" id="typeLegend"></div>
        </div>
      </div>
    </section>

    <section class="card fadeIn">
      <div class="hd"><h2>Most common open ports</h2><div class="sub">Top 10 by host count</div></div>
      <div class="bd">
        <div class="bars" id="portBars"></div>
      </div>
    </section>

    <section class="card fadeIn">
      <div class="hd"><h2>Risky surfaces</h2><div class="sub">What’s exposed right now</div></div>
      <div class="bd">
        <table class="table" id="riskTable">
          <thead><tr><th>Device</th><th>IP</th><th>Flags</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="card fadeIn">
      <div class="hd"><h2>New & gone (last hour)</h2><div class="sub">From latest snapshot delta</div></div>
      <div class="bd" id="deltaBox">
        <div class="muted">No delta data found.</div>
      </div>
    </section>
  </div>
</main>

<footer>
  Uses <code>/latest.json</code> (refreshed hourly). Charts animate with Anime.js.
</footer>

<script>
  const COLORS = {
    gateway: '#7aa2ff',
    nas: '#3ddc97',
    ap: '#ffcc66',
    tv: '#c7a6ff',
    printer: '#ff7aa2',
    iot: '#66e0ff',
    server: '#a3ff66',
    client: '#ffd166',
    unknown: '#94a3b8'
  };

  function esc(s){
    return (s||'').replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function arcPath(cx, cy, rOuter, rInner, a0, a1){
    const p = (a) => ({ x: cx + Math.cos(a) * rOuter, y: cy + Math.sin(a) * rOuter });
    const q = (a) => ({ x: cx + Math.cos(a) * rInner, y: cy + Math.sin(a) * rInner });
    const A0 = p(a0), A1 = p(a1), B1 = q(a1), B0 = q(a0);
    const large = (a1 - a0) > Math.PI ? 1 : 0;
    return [
      `M ${A0.x.toFixed(2)} ${A0.y.toFixed(2)}`,
      `A ${rOuter} ${rOuter} 0 ${large} 1 ${A1.x.toFixed(2)} ${A1.y.toFixed(2)}`,
      `L ${B1.x.toFixed(2)} ${B1.y.toFixed(2)}`,
      `A ${rInner} ${rInner} 0 ${large} 0 ${B0.x.toFixed(2)} ${B0.y.toFixed(2)}`,
      'Z'
    ].join(' ');
  }

  function buildDonut(types){
    const svg = document.getElementById('ring');
    svg.innerHTML = '';
    const legend = document.getElementById('typeLegend');
    legend.innerHTML = '';

    const entries = Object.entries(types).sort((a,b)=>b[1]-a[1]);
    const total = entries.reduce((s,[,v])=>s+v,0) || 1;

    const cx=120, cy=120, rO=96, rI=62;
    let a = -Math.PI/2;

    entries.forEach(([k,v], idx) => {
      const frac = v/total;
      const a1 = a + frac * Math.PI*2;
      const path = document.createElementNS('http://www.w3.org/2000/svg','path');
      const color = COLORS[k] || COLORS.unknown;
      path.setAttribute('d', arcPath(cx,cy,rO,rI,a,a1));
      path.setAttribute('fill', color);
      path.setAttribute('opacity', '0.9');
      path.setAttribute('data-key', k);
      path.setAttribute('stroke', 'rgba(255,255,255,.06)');
      path.setAttribute('stroke-width', '1');
      svg.appendChild(path);

      const li = document.createElement('div');
      li.className = 'legendItem';
      li.innerHTML = `
        <div class='left'><span class='dot' style='background:${color}'></span>${esc(k)}</div>
        <div class='right'>${v} (${Math.round(frac*100)}%)</div>
      `;
      legend.appendChild(li);

      a = a1;
    });

    // Animate drawing: scale + stagger (optional)
    if (window.anime) {
      anime({
        targets: '#ring path',
        scale: [0.95, 1],
        opacity: [0, 0.9],
        easing: 'easeOutExpo',
        duration: 900,
        delay: anime.stagger(55)
      });
    }

    // Center label
    const txt1 = document.createElementNS('http://www.w3.org/2000/svg','text');
    txt1.setAttribute('x', cx);
    txt1.setAttribute('y', cy-4);
    txt1.setAttribute('text-anchor','middle');
    txt1.setAttribute('fill','rgba(232,237,255,.92)');
    txt1.setAttribute('font-size','24');
    txt1.setAttribute('font-weight','700');
    txt1.textContent = total;
    svg.appendChild(txt1);

    const txt2 = document.createElementNS('http://www.w3.org/2000/svg','text');
    txt2.setAttribute('x', cx);
    txt2.setAttribute('y', cy+18);
    txt2.setAttribute('text-anchor','middle');
    txt2.setAttribute('fill','rgba(154,167,214,.9)');
    txt2.setAttribute('font-size','11');
    txt2.textContent = 'devices';
    svg.appendChild(txt2);

    if (window.anime) anime({ targets:[txt1,txt2], opacity:[0,1], translateY:[6,0], easing:'easeOutExpo', duration:850, delay:180 });
  }

  function buildBars(portCounts){
    const root = document.getElementById('portBars');
    root.innerHTML = '';
    const entries = Object.entries(portCounts).sort((a,b)=>b[1]-a[1]).slice(0,10);
    const max = Math.max(...entries.map(e=>e[1]), 1);

    entries.forEach(([port, count]) => {
      const row = document.createElement('div');
      row.className = 'bar';
      row.innerHTML = `
        <div class='name'><code>${esc(port)}</code></div>
        <div class='track'><div class='fill' data-val='${(count/max*100).toFixed(2)}'></div></div>
        <div class='val'>${count} hosts</div>
      `;
      root.appendChild(row);
    });

    if (window.anime) {
      anime({
        targets: '#portBars .fill',
        width: (el) => (el.getAttribute('data-val')||'0') + '%',
        easing: 'easeOutExpo',
        duration: 900,
        delay: anime.stagger(60)
      });
    } else {
      document.querySelectorAll('#portBars .fill').forEach(el => {
        el.style.width = (el.getAttribute('data-val')||'0') + '%';
      });
    }
  }

  function buildRiskTable(devs){
    const tbody = document.querySelector('#riskTable tbody');
    tbody.innerHTML = '';
    const risky = devs
      .filter(d => (d.risk_flags||[]).length)
      .sort((a,b) => (b.risk_flags.length - a.risk_flags.length))
      .slice(0, 18);

    risky.forEach(d => {
      const tr = document.createElement('tr');
      const label = d.name || d.hostname || d.vendor || d.id;
      const flags = (d.risk_flags||[]).map(f => {
        const lower = f.toLowerCase();
        const cls = lower.includes('smb') || lower.includes('ssh') ? 'bad' : (lower.includes('admin') ? 'warn' : 'warn');
        return `<span class='pill ${cls}'>${esc(f)}</span>`;
      }).join(' ');
      tr.innerHTML = `
        <td><a href='/device.html?id=${encodeURIComponent(d.id)}'>${esc(label)}</a><div class='meta'>${esc(d.type||'')}</div></td>
        <td><code>${esc(d.ip||'')}</code></td>
        <td>${flags}</td>
      `;
      tbody.appendChild(tr);
    });

    if (window.anime) anime({
      targets: '#riskTable tbody tr',
      opacity: [0, 1],
      translateY: [6, 0],
      easing: 'easeOutExpo',
      duration: 650,
      delay: anime.stagger(35)
    });
  }

  function buildDelta(delta, devsById){
    const box = document.getElementById('deltaBox');
    const n = (delta?.new_ids||[]);
    const g = (delta?.gone_ids||[]);
    const lines = [];

    function fmt(id){
      const d = devsById[id];
      if(!d) return id;
      const label = d.name || d.hostname || d.vendor || id;
      return `${label} (${d.mac||id}) @ ${d.ip||''}`.trim();
    }

    if(!n.length && !g.length){
      box.innerHTML = `<div class='muted'>No delta reported in latest snapshot.</div>`;
      return;
    }

    const parts = [];
    if(n.length){
      parts.push(`<div class='pill good'>+${n.length} new</div>`);
    }
    if(g.length){
      parts.push(`<div class='pill warn'>-${g.length} gone</div>`);
    }

    const ulNew = n.length ? `<h3 style='margin:10px 0 6px 0'>New</h3><ul>${n.slice(0,12).map(id=>`<li>${esc(fmt(id))}</li>`).join('')}</ul>` : '';
    const ulGone = g.length ? `<h3 style='margin:10px 0 6px 0'>Gone</h3><ul>${g.slice(0,12).map(id=>`<li>${esc(fmt(id))}</li>`).join('')}</ul>` : '';

    box.innerHTML = `<div class='flex'>${parts.join('')}</div>${ulNew}${ulGone}`;
    if (window.anime) anime({ targets:'#deltaBox ul li', opacity:[0,1], translateX:[-6,0], easing:'easeOutExpo', duration:600, delay:anime.stagger(40) });
  }

  async function main(){
    const resp = await fetch('/latest.json', {cache:'no-store'}).catch(()=>null);
    if(!resp){
      document.getElementById('meta').textContent = 'Failed to load /latest.json';
      return;
    }
    const data = await resp.json();
    const devs = data.devices || [];

    const types = {};
    const portCounts = {}; // port -> host count
    let openHosts = 0;
    let openPorts = 0;
    let risks = 0;

    const devsById = {};
    devs.forEach(d => { devsById[d.id] = d; });

    devs.forEach(d => {
      types[d.type || 'unknown'] = (types[d.type || 'unknown'] || 0) + 1;
      const ports = (d.open_ports || []).map(p => p.port).filter(Boolean);
      if(ports.length) openHosts += 1;
      openPorts += ports.length;
      (d.risk_flags || []).forEach(_ => risks += 1);

      // host count per port
      const uniquePorts = new Set(ports);
      uniquePorts.forEach(p => { portCounts[p] = (portCounts[p] || 0) + 1; });
    });

    document.getElementById('meta').innerHTML = `Updated: <code>${esc(data.timestamp_human||'')}</code> • Subnet: <code>${esc(data.subnet||'')}</code>`;
    document.getElementById('kpiDevices').textContent = devs.length;
    document.getElementById('kpiOpenHosts').textContent = openHosts;
    document.getElementById('kpiOpenPorts').textContent = openPorts;
    document.getElementById('kpiRisks').textContent = risks;

    buildDonut(types);
    buildBars(portCounts);
    buildRiskTable(devs);
    buildDelta(data.diff, devsById);

    if (window.anime) anime({ targets: '.fadeIn', opacity:[0,1], translateY:[10,0], easing:'easeOutExpo', duration:850, delay: anime.stagger(90) });
  }

  main();
</script>
</body>
</html>
