<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Network Watch — Fancy Timeline</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <style>
    :root{
      --bg:#0b1020; --panel:#101a33; --panel2:#0f1730;
      --text:#e8edff; --muted:#9aa7d6; --grid:#223056; --accent:#7aa2ff;
      --good:#3ddc97; --warn:#ffcc66; --bad:#ff5c7a; --shadow:0 20px 70px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    body{margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background: radial-gradient(1200px 800px at 20% 0%, #17224a 0%, var(--bg) 55%),
                  radial-gradient(1000px 700px at 90% 20%, #1b2b5c 0%, var(--bg) 60%);
      min-height:100vh;
    }
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    header{padding:24px 22px 10px 22px; position:sticky; top:0; backdrop-filter: blur(10px);
      background: rgba(11,16,32,.55); border-bottom:1px solid rgba(255,255,255,.06); z-index:10;}
    .row{display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap:wrap;}
    h1{margin:0; font-size:20px; letter-spacing:.3px;}
    .meta{color:var(--muted); font-size:12px;}
    .nav{display:flex; gap:12px; flex-wrap:wrap; font-size:13px;}
    main{padding:18px 22px 36px 22px;}
    .grid{display:grid; grid-template-columns: 1fr; gap:16px;}
    .card{background: linear-gradient(180deg, rgba(16,26,51,.95) 0%, rgba(15,23,48,.86) 100%);
      border:1px solid rgba(255,255,255,.07); border-radius:16px; box-shadow:var(--shadow); overflow:hidden;}
    .hd{padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.06); display:flex; align-items:baseline; justify-content:space-between; gap:12px;}
    .hd h2{margin:0; font-size:14px;}
    .sub{color:var(--muted); font-size:12px;}
    .bd{padding:14px 16px;}

    .kpis{display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:10px;}
    @media (max-width:980px){ .kpis{grid-template-columns: repeat(2,minmax(0,1fr));} }
    .kpi{padding:12px; border-radius:14px; border:1px solid rgba(255,255,255,.07); background:rgba(0,0,0,.14)}
    .kpi .label{color:var(--muted); font-size:12px;}
    .kpi .value{font-size:22px; margin-top:4px; font-weight:700;}

    .chartWrap{display:grid; grid-template-columns: 1.1fr .9fr; gap:14px; align-items:start;}
    @media (max-width:980px){ .chartWrap{grid-template-columns:1fr;} }

    .legend{display:grid; gap:8px; min-width:240px;}
    .legendItem{display:flex; align-items:center; justify-content:space-between; gap:10px; font-size:13px;}
    .left{display:flex; align-items:center; gap:8px;}
    .dot{width:10px; height:10px; border-radius:999px; box-shadow:0 0 0 2px rgba(255,255,255,.08) inset}
    .muted{color:var(--muted)}

    svg{width:100%; height:auto; display:block}
    .axis text{fill:rgba(154,167,214,.9); font-size:11px}
    .axis line{stroke:rgba(255,255,255,.08)}
    .gridline{stroke:rgba(255,255,255,.06)}

    .pill{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.18); font-size:12px;}
    .pill.bad{border-color: rgba(255,92,122,.35); color:#ffd7df}
    .pill.warn{border-color: rgba(255,204,102,.35); color:#fff0cc}
    .pill.good{border-color: rgba(61,220,151,.35); color:#d6fff0}

    .bars{display:grid; gap:8px;}
    .bar{display:grid; grid-template-columns: 120px 1fr 70px; gap:10px; align-items:center;}
    .track{height:10px; background:rgba(255,255,255,.08); border-radius:999px; overflow:hidden; border:1px solid rgba(255,255,255,.06)}
    .fill{height:100%; width:0%; background: linear-gradient(90deg, rgba(122,162,255,1), rgba(61,220,151,1)); border-radius:999px;}
    code{background:#0b122a; padding:2px 6px; border-radius:6px; border:1px solid rgba(255,255,255,.08)}
  </style>
</head>
<body>
<header>
  <div class="row">
    <div>
      <h1>Network Watch — Fancy Timeline</h1>
      <div class="meta" id="meta">Loading history…</div>
    </div>
    <div class="nav">
      <a href="/">Dashboard</a>
      <a href="/fancy.html">Fancy (latest)</a>
      <a href="/timeline.html">Timeline</a>
      <a href="/ip-history.html">IP history</a>
      <a href="/churn.html">Churn</a>
    </div>
  </div>
</header>

<main>
  <div class="kpis">
    <div class="kpi"><div class="label">Snapshots shown</div><div class="value" id="kSnapshots">–</div></div>
    <div class="kpi"><div class="label">Devices now</div><div class="value" id="kNow">–</div></div>
    <div class="kpi"><div class="label">Open ports now</div><div class="value" id="kPorts">–</div></div>
    <div class="kpi"><div class="label">Risk flags now</div><div class="value" id="kRisks">–</div></div>
  </div>

  <div style="height:14px"></div>

  <div class="grid">
    <section class="card">
      <div class="hd"><h2>Time series</h2><div class="sub">Devices / open ports / risk flags (last ~48 hours)</div></div>
      <div class="bd">
        <div class="chartWrap">
          <svg id="ts" viewBox="0 0 920 320" role="img" aria-label="Time series chart"></svg>
          <div class="legend" id="tsLegend"></div>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="hd"><h2>Top ports trend (latest snapshot)</h2><div class="sub">Most common open ports by host count</div></div>
      <div class="bd"><div class="bars" id="bars"></div></div>
    </section>
  </div>
</main>

<script>
  const COLORS = {
    devices: '#7aa2ff',
    openPorts: '#3ddc97',
    risks: '#ff5c7a'
  };

  function esc(s){
    return (s||'').replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function buildLegend(){
    const root = document.getElementById('tsLegend');
    root.innerHTML = `
      <div class='legendItem'><div class='left'><span class='dot' style='background:${COLORS.devices}'></span>Devices</div><div class='muted'>count</div></div>
      <div class='legendItem'><div class='left'><span class='dot' style='background:${COLORS.openPorts}'></span>Open ports</div><div class='muted'>total entries</div></div>
      <div class='legendItem'><div class='left'><span class='dot' style='background:${COLORS.risks}'></span>Risk flags</div><div class='muted'>sum</div></div>
      <div class='muted' style='margin-top:8px'>Hover points for timestamp.</div>
    `;
  }

  function polyline(points){
    return points.map(p => `${p[0].toFixed(1)},${p[1].toFixed(1)}`).join(' ');
  }

  function scaleSeries(values, minY, maxY){
    const mn = Math.min(...values);
    const mx = Math.max(...values);
    const rng = (mx - mn) || 1;
    return values.map(v => minY + (1 - ((v - mn) / rng)) * (maxY - minY));
  }

  function drawTimeSeries(svg, series){
    const W=920, H=320;
    const padL=56, padR=16, padT=20, padB=38;
    const x0=padL, x1=W-padR;
    const y0=padT, y1=H-padB;

    svg.innerHTML = '';

    // gridlines
    for(let i=0;i<=4;i++){
      const y = y0 + (i/4)*(y1-y0);
      const line = document.createElementNS('http://www.w3.org/2000/svg','line');
      line.setAttribute('x1', x0); line.setAttribute('x2', x1);
      line.setAttribute('y1', y); line.setAttribute('y2', y);
      line.setAttribute('class','gridline');
      svg.appendChild(line);
    }

    const n = series.t.length;
    const xs = Array.from({length:n}, (_,i)=> x0 + (i/(Math.max(1,n-1)))*(x1-x0));

    const yDevices = scaleSeries(series.devices, y0, y1);
    const yPorts = scaleSeries(series.openPorts, y0, y1);
    const yRisks = scaleSeries(series.risks, y0, y1);

    function addPath(name, ys, color){
      const pts = xs.map((x,i)=>[x, ys[i]]);
      const pl = document.createElementNS('http://www.w3.org/2000/svg','polyline');
      pl.setAttribute('fill','none');
      pl.setAttribute('stroke', color);
      pl.setAttribute('stroke-width','3');
      pl.setAttribute('stroke-linejoin','round');
      pl.setAttribute('stroke-linecap','round');
      pl.setAttribute('points', polyline(pts));
      pl.setAttribute('opacity','0.95');
      pl.setAttribute('data-series', name);
      svg.appendChild(pl);

      // points
      pts.forEach((p,i)=>{
        const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
        c.setAttribute('cx', p[0]); c.setAttribute('cy', p[1]);
        c.setAttribute('r', '4');
        c.setAttribute('fill', color);
        c.setAttribute('opacity', '0.9');
        c.setAttribute('data-tip', `${name}=${series[name][i]} @ ${series.t[i]}`);
        c.addEventListener('mouseenter', () => {
          document.getElementById('meta').innerHTML = `Hover: <code>${esc(c.getAttribute('data-tip'))}</code>`;
        });
        svg.appendChild(c);
      });
    }

    addPath('devices', yDevices, COLORS.devices);
    addPath('openPorts', yPorts, COLORS.openPorts);
    addPath('risks', yRisks, COLORS.risks);

    // axes
    const ax = document.createElementNS('http://www.w3.org/2000/svg','g');
    ax.setAttribute('class','axis');
    const xLine = document.createElementNS('http://www.w3.org/2000/svg','line');
    xLine.setAttribute('x1', x0); xLine.setAttribute('x2', x1);
    xLine.setAttribute('y1', y1); xLine.setAttribute('y2', y1);
    ax.appendChild(xLine);
    const yLine = document.createElementNS('http://www.w3.org/2000/svg','line');
    yLine.setAttribute('x1', x0); yLine.setAttribute('x2', x0);
    yLine.setAttribute('y1', y0); yLine.setAttribute('y2', y1);
    ax.appendChild(yLine);
    svg.appendChild(ax);

    // x labels (start, mid, end)
    const idxs = [0, Math.floor((n-1)/2), n-1].filter(i=>i>=0);
    idxs.forEach(i=>{
      const tx = document.createElementNS('http://www.w3.org/2000/svg','text');
      tx.setAttribute('x', xs[i]);
      tx.setAttribute('y', H-14);
      tx.setAttribute('text-anchor', i===0?'start':(i===n-1?'end':'middle'));
      tx.textContent = series.t[i];
      svg.appendChild(tx);
    });

    // Animations
    if(window.anime){
      const paths = svg.querySelectorAll('polyline');
      paths.forEach(pl=>{
        const len = pl.getTotalLength();
        pl.style.strokeDasharray = len;
        pl.style.strokeDashoffset = len;
      });
      anime({
        targets: svg.querySelectorAll('polyline'),
        strokeDashoffset: [anime.setDashoffset, 0],
        easing: 'easeOutExpo',
        duration: 1200,
        delay: anime.stagger(120)
      });
      anime({
        targets: svg.querySelectorAll('circle'),
        r: [0,4],
        opacity: [0,0.9],
        easing: 'easeOutBack',
        duration: 900,
        delay: anime.stagger(6)
      });
    }
  }

  function buildBars(portCounts){
    const root = document.getElementById('bars');
    root.innerHTML = '';
    const entries = Object.entries(portCounts).sort((a,b)=>b[1]-a[1]).slice(0,12);
    const max = Math.max(...entries.map(e=>e[1]), 1);
    entries.forEach(([port, count]) => {
      const row = document.createElement('div');
      row.className = 'bar';
      row.innerHTML = `
        <div class='muted'><code>${esc(port)}</code></div>
        <div class='track'><div class='fill' data-val='${(count/max*100).toFixed(2)}'></div></div>
        <div style='text-align:right'>${count} hosts</div>
      `;
      root.appendChild(row);
    });

    const fills = root.querySelectorAll('.fill');
    if(window.anime){
      anime({
        targets: fills,
        width: (el) => (el.getAttribute('data-val')||'0') + '%',
        easing: 'easeOutExpo',
        duration: 900,
        delay: anime.stagger(60)
      });
    } else {
      fills.forEach(el => el.style.width = (el.getAttribute('data-val')||'0') + '%');
    }
  }

  async function main(){
    buildLegend();

    const [latestResp, histResp] = await Promise.all([
      fetch('/latest.json', {cache:'no-store'}).catch(()=>null),
      fetch('/history.json', {cache:'no-store'}).catch(()=>null)
    ]);
    if(!latestResp || !histResp){
      document.getElementById('meta').textContent = 'Failed to load /latest.json or /history.json';
      return;
    }
    const latest = await latestResp.json();
    const hist = await histResp.json();

    document.getElementById('kSnapshots').textContent = (hist.t||[]).length;
    document.getElementById('kNow').textContent = (latest.devices||[]).length;

    let openPortsNow = 0;
    let risksNow = 0;
    const portCounts = {};
    (latest.devices||[]).forEach(d=>{
      const ports = (d.open_ports||[]).map(p=>p.port).filter(Boolean);
      openPortsNow += ports.length;
      (d.risk_flags||[]).forEach(_=>risksNow++);
      new Set(ports).forEach(p=> portCounts[p] = (portCounts[p]||0)+1);
    });
    document.getElementById('kPorts').textContent = openPortsNow;
    document.getElementById('kRisks').textContent = risksNow;

    const svg = document.getElementById('ts');
    drawTimeSeries(svg, hist);
    buildBars(portCounts);

    document.getElementById('meta').innerHTML = `Updated: <code>${esc(latest.timestamp_human||'')}</code> • History: <code>${esc((hist.t||[]).length + ' points')}</code>`;
  }

  main();
</script>
</body>
</html>
